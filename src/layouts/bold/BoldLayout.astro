---
import '@fontsource/space-grotesk/400.css'
import '@fontsource/space-grotesk/500.css'
import '@fontsource/space-grotesk/600.css'
import '@fontsource/space-grotesk/700.css'
import '@fontsource/dm-sans/400.css'
import '@fontsource/dm-sans/500.css'
import '@fontsource/dm-sans/700.css'
import BaseLayout from '@layouts/BaseLayout.astro'
import SEO from '@components/shared/SEO.astro'
import BoldNav from '@components/bold/BoldNav.astro'
import BoldFooter from '@components/bold/BoldFooter.astro'
import { boldTheme } from '@themes/bold'
import { buildThemeCssVars } from '@lib/theme-css-vars'
import type { ThemeId } from '@themes/types'

interface Props {
  title?: string
  description?: string
  image?: string
  canonical?: string
  noindex?: boolean
  currentTheme?: ThemeId
}

const {
  title,
  description,
  image,
  canonical,
  noindex,
  currentTheme = Astro.locals.theme,
} = Astro.props
---

<BaseLayout>
  <SEO
    slot="head"
    title={title}
    description={description}
    image={image}
    canonical={canonical}
    noindex={noindex}
    theme={boldTheme}
  />
  <div data-theme={boldTheme.id} style={buildThemeCssVars(boldTheme)}>
    <BoldNav currentTheme={currentTheme} />
    <slot />
    <BoldFooter />
  </div>
</BaseLayout>

{/* Scroll-reveal: IntersectionObserver adds .revealed to .reveal elements */}
<script>
  function initBoldScrollReveal(): void {
    const elements = document.querySelectorAll<HTMLElement>('.reveal')
    if (elements.length === 0) return

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('revealed')
            observer.unobserve(entry.target)
          }
        })
      },
      { threshold: 0.08, rootMargin: '0px 0px -40px 0px' }
    )

    elements.forEach((el) => observer.observe(el))
  }

  initBoldScrollReveal()
</script>

{/* Stats counter animation */}
<script>
  function initStatsCounter(): void {
    const statsSection = document.getElementById('bold-stats')
    if (!statsSection) return

    let counted = false
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !counted) {
            counted = true
            document.querySelectorAll<HTMLElement>('[data-counter]').forEach((el) => {
              const target = parseFloat(el.dataset.target || '0')
              const suffix = el.dataset.suffix || ''
              const isDecimal = el.dataset.decimal === 'true'
              const duration = 1200
              const start = performance.now()

              function update(now: number): void {
                const elapsed = now - start
                const progress = Math.min(elapsed / duration, 1)
                const eased = 1 - Math.pow(1 - progress, 3)
                const current = isDecimal
                  ? (target * eased).toFixed(1)
                  : Math.floor(target * eased).toLocaleString()
                el.textContent = current + suffix
                if (progress < 1) requestAnimationFrame(update)
              }

              requestAnimationFrame(update)
            })
          }
        })
      },
      { threshold: 0.3 }
    )

    observer.observe(statsSection)
  }

  initStatsCounter()
</script>

<style is:global>
  /* Scroll-reveal base â€” elements start hidden, animate in when .revealed */
  .reveal {
    opacity: 0;
    transform: translateY(40px);
    transition:
      opacity 0.7s ease,
      transform 0.7s ease;
  }

  .reveal--left {
    opacity: 0;
    transform: translateX(-60px);
    transition:
      opacity 0.7s ease,
      transform 0.7s ease;
  }

  .reveal--right {
    opacity: 0;
    transform: translateX(60px);
    transition:
      opacity 0.7s ease,
      transform 0.7s ease;
  }

  .revealed {
    opacity: 1;
    transform: translate(0, 0);
  }

  /* Stagger children for grid reveals */
  .reveal-stagger > * {
    opacity: 0;
    transform: translateY(30px);
    transition:
      opacity 0.5s ease,
      transform 0.5s ease;
  }

  .revealed .reveal-stagger > * {
    opacity: 1;
    transform: translateY(0);
  }

  .revealed .reveal-stagger > *:nth-child(1) {
    transition-delay: 0ms;
  }
  .revealed .reveal-stagger > *:nth-child(2) {
    transition-delay: 120ms;
  }
  .revealed .reveal-stagger > *:nth-child(3) {
    transition-delay: 240ms;
  }
  .revealed .reveal-stagger > *:nth-child(4) {
    transition-delay: 360ms;
  }
  .revealed .reveal-stagger > *:nth-child(5) {
    transition-delay: 480ms;
  }
  .revealed .reveal-stagger > *:nth-child(6) {
    transition-delay: 600ms;
  }
</style>
