---
import '@fontsource/playfair-display/400.css'
import '@fontsource/playfair-display/600.css'
import '@fontsource/lato/300.css'
import '@fontsource/lato/400.css'
import BaseLayout from '@layouts/BaseLayout.astro'
import SEO from '@components/shared/SEO.astro'
import NoirNav from '@components/noir/NoirNav.astro'
import NoirFooter from '@components/noir/NoirFooter.astro'
import { noirTheme } from '@themes/noir'
import { buildThemeCssVars } from '@lib/theme-css-vars'
import type { ThemeId } from '@themes/types'

interface Props {
  title?: string
  description?: string
  image?: string
  canonical?: string
  noindex?: boolean
  currentTheme?: ThemeId
}

const {
  title,
  description,
  image,
  canonical,
  noindex,
  currentTheme = Astro.locals.theme,
} = Astro.props
---

<BaseLayout>
  <SEO
    slot="head"
    title={title}
    description={description}
    image={image}
    canonical={canonical}
    noindex={noindex}
    theme={noirTheme}
  />
  <div data-theme={noirTheme.id} style={buildThemeCssVars(noirTheme)} class="noir-root">
    <NoirNav currentTheme={currentTheme} />
    <slot />
    <NoirFooter />
  </div>
</BaseLayout>

{/* Scroll-reveal: slow, elegant fade-in */}
<script>
  function initNoirScrollReveal(): void {
    const elements = document.querySelectorAll<HTMLElement>('.reveal')
    if (elements.length === 0) return

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('revealed')
            observer.unobserve(entry.target)
          }
        })
      },
      { threshold: 0.1, rootMargin: '0px 0px -40px 0px' }
    )

    elements.forEach((el) => observer.observe(el))
  }

  initNoirScrollReveal()
</script>

<style is:global>
  /* Film grain texture overlay */
  .noir-root {
    position: relative;
    background: var(--color-background);
    min-height: 100vh;
  }

  .noir-root::after {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
    opacity: 0.035;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    background-repeat: repeat;
    background-size: 256px 256px;
  }

  /* Scroll-reveal base â€” slow, elegant */
  .reveal {
    opacity: 0;
    transform: translateY(20px);
    transition:
      opacity 0.8s ease,
      transform 0.8s ease;
  }

  .revealed {
    opacity: 1;
    transform: translateY(0);
  }

  /* Stagger children for grid reveals */
  .reveal-stagger > * {
    opacity: 0;
    transform: translateY(16px);
    transition:
      opacity 0.6s ease,
      transform 0.6s ease;
  }

  .revealed .reveal-stagger > * {
    opacity: 1;
    transform: translateY(0);
  }

  .revealed .reveal-stagger > *:nth-child(1) {
    transition-delay: 0ms;
  }
  .revealed .reveal-stagger > *:nth-child(2) {
    transition-delay: 120ms;
  }
  .revealed .reveal-stagger > *:nth-child(3) {
    transition-delay: 240ms;
  }
  .revealed .reveal-stagger > *:nth-child(4) {
    transition-delay: 360ms;
  }
  .revealed .reveal-stagger > *:nth-child(5) {
    transition-delay: 480ms;
  }
  .revealed .reveal-stagger > *:nth-child(6) {
    transition-delay: 600ms;
  }

  /* Gold line draw-in animation for .gold-rule elements */
  .gold-rule {
    transform: scaleX(0);
    transition: transform 0.6s ease;
  }

  .revealed .gold-rule {
    transform: scaleX(1);
  }
</style>
